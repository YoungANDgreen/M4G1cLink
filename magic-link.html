<html>
  <body>
    <script>
      // Get the full URL and original link parameters
      const urlParams = new URLSearchParams(window.location.search);
      const originalLink = decodeURIComponent(urlParams.get('link') || '');
      const originalUrl = new URL(originalLink);
      const originalParams = new URLSearchParams(originalUrl.search);

      const oobCode = originalParams.get('oobCode');
      const apiKey = originalParams.get('apiKey');
      const mode = originalParams.get('mode');

      console.log('Original Query Parameters:', Object.fromEntries(originalParams));
      console.log('Current Query Parameters:', Object.fromEntries(urlParams));

      if (oobCode && apiKey && mode === 'signIn') {
        console.log('Firebase Magic Link parameters:', { oobCode, apiKey, mode });
        const redirectUrl = 'bkg://auth/callback?oobCode=' + encodeURIComponent(oobCode);
        console.log('Attempting redirect to:', redirectUrl);

        if (window.location.protocol === 'http:' || window.location.protocol === 'https:') {
          alert('Web test: Please copy this URL and paste it into your browser to complete sign-in:\n' + originalLink);
        }
        window.location.href = redirectUrl;
      } else {
        alert('Invalid Magic Link. No authentication token found. Original Parameters: ' + JSON.stringify(Object.fromEntries(originalParams)));
      }
    </script>
  </body>
</html>
